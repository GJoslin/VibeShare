# =========================
# Pipeline: Docker to Azure App Service
# =========================
trigger:
- main  # or your branch

variables:
  dockerHubNamespace: 'vibehub'           # your Docker Hub username/org
  imageName: 'vibeshare-app'              # Docker image name
  azureServiceConnection: 'VShareAppPCon' # ARM service connection name
  appName: 'VibeShare'                    # Azure App Service name

stages:
- stage: BuildAndDeploy
  displayName: 'Build and Deploy Docker Container'
  jobs:
  - job: Docker
    displayName: 'Docker Login, Build, and Push'
    steps:

    # -------------------
    # Step 1: Docker Login
    # -------------------
    - task: Docker@2
      displayName: 'Login to Docker Hub'
      inputs:
        command: login
        containerRegistry: 'VibeShareCon'  # Your Docker Hub service connection

    # -------------------
    # Step 2: Build Docker image (optional if you build in pipeline)
    # -------------------
    - task: Docker@2
      displayName: 'Build Docker Image'
      inputs:
        command: build
        Dockerfile: '**/Dockerfile'
        tags: $(dockerHubNamespace)/$(imageName):latest

    # -------------------
    # Step 3: Push Docker image to Docker Hub
    # -------------------
    - task: Docker@2
      displayName: 'Push Docker Image'
      inputs:
        command: push
        tags: $(dockerHubNamespace)/$(imageName):latest

    # -------------------
    # Step 4: Deploy to Azure App Service
    # -------------------
    - task: AzureWebAppContainer@1
      displayName: 'Deploy to Azure App Service'
      inputs:
        azureSubscription: $(azureServiceConnection)
        appName: $(appName)
        imageName: $(dockerHubNamespace)/$(imageName):latest
