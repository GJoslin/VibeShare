trigger:
- main  # Adjust to your branch

variables:
  dockerHubNamespace: 'vibehub'           # Your Docker Hub username/org
  imageName: 'vibeshare-app'              # Docker image name
  azureServiceConnection: 'VShareAppPCon' # ARM service connection name
  appName: 'vibeShare'                    # Azure App Service name

stages:
- stage: BuildAndDeploy
  displayName: 'Build, Push, and Deploy Docker Container'
  jobs:
  - job: DockerDeploy
    displayName: 'Docker Build, Push, and Azure Deployment'
    steps:

    # -------------------
    # Step 1: Docker Login
    # -------------------
    - task: Docker@2
      displayName: 'Login to Docker Hub'
      inputs:
        command: login
        containerRegistry: 'VibeShareCon'  # Your Docker Hub service connection

    # -------------------
    # Step 2: Build Docker image with proper tag
    # -------------------
    - task: Docker@2
      displayName: 'Build Docker Image'
      inputs:
        command: build
        Dockerfile: '**/Dockerfile'
        buildContext: '.'  # Project root or folder containing Dockerfile
        tags: $(dockerHubNamespace)/$(imageName):latest

    # -------------------
    # Step 3: Push Docker image
    # -------------------
    - task: Docker@2
      displayName: 'Push Docker Image'
      inputs:
        command: push
        tags: $(dockerHubNamespace)/$(imageName):latest

    # -------------------
    # Step 4: Deploy to Azure App Service
    # -------------------
    - task: AzureWebAppContainer@1
      displayName: 'Deploy to Azure App Service'
      inputs:
        azureSubscription: $(azureServiceConnection)
        appName: $(appName)
        imageName: $(dockerHubNamespace)/$(imageName):latest
