trigger:
  branches:
    include:
      - main  # Trigger pipeline on main branch

pool:
  vmImage: 'windows-latest'  # Or 'ubuntu-latest'

variables:
  nodeVersion: '22.x'   # Node.js version
  buildDir: '$(Build.ArtifactStagingDirectory)'

steps:

# 1️⃣ Install Node.js
- task: NodeTool@0
  inputs:
    versionSpec: '$(nodeVersion)'
  displayName: 'Install Node.js'

# 2️⃣ Install dependencies & build standalone
- script: |
    npm install
    npm run build
  displayName: 'Install dependencies & build Next.js'

# 3️⃣ Optional: List .next folder for debugging
- script: dir .next
  displayName: 'List .next folder contents'

# 4️⃣ Copy required files to staging directory
- task: CopyFiles@2
  inputs:
    SourceFolder: '.next/standalone'
    Contents: '**/*'
    TargetFolder: '$(buildDir)/standalone'
- task: CopyFiles@2
  inputs:
    SourceFolder: '.next/static'
    Contents: '**/*'
    TargetFolder: '$(buildDir)/standalone/.next/static'

# 5️⃣ Archive the standalone folder into a zip
- task: ArchiveFiles@2
  inputs:
    rootFolderOrFile: '$(buildDir)/standalone'
    includeRootFolder: false
    archiveType: 'zip'
    archiveFile: '$(buildDir)/standalone.zip'
    replaceExistingArchive: true
  displayName: 'Archive standalone build'

# 6️⃣ Deploy the zip to Azure Web App
- task: AzureWebApp@1
  inputs:
    azureSubscription: 'VShareAppPCon'
    appName: 'VibeShare'
    package: '$(buildDir)/standalone.zip'
    enableCustomDeployment: true
  displayName: 'Deploy to Azure Web App'
